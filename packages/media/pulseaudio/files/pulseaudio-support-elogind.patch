Upstream: No
Author: Rasmus Thomsen <cogitri@exherbo.org>
Reason: Support elogind session tracking
diff --git a/configure.ac b/configure.ac
index 77b5ff5..1f9709d 100644
--- a/configure.ac
+++ b/configure.ac
@@ -1220,6 +1220,11 @@ AC_ARG_ENABLE([systemd-login],
 AC_ARG_ENABLE([systemd-journal],
     AS_HELP_STRING([--disable-systemd-journal],[Disable optional systemd journal support]))
 
+#### elogind support (optional) ####
+
+AC_ARG_ENABLE([elogind-login],
+    AS_HELP_STRING([--disable-elogind-login],[Disable optional elogind login support]))
+
 # Newer systemd's combine their subcomponent libraries into one
 # If it exists, we should use it for the further checks
 
@@ -1267,6 +1272,19 @@ AC_SUBST(HAVE_SYSTEMD_LOGIN)
 AM_CONDITIONAL([HAVE_SYSTEMD_LOGIN], [test "x$HAVE_SYSTEMD_LOGIN" = x1])
 AS_IF([test "x$HAVE_SYSTEMD_LOGIN" = "x1"], AC_DEFINE([HAVE_SYSTEMD_LOGIN], 1, [Have SYSTEMDLOGIN?]))
 
+#### elogind login support (optional) ####
+
+AS_IF([test "x$enable_elogind_login" != "xno"],
+    [AS_IF([test "x$HAVE_ELOGIND_LOGIN" != "x1"], [PKG_CHECK_MODULES(LIBELOGIND, [ libelogind ], HAVE_ELOGIND_LOGIN=1, HAVE_ELOGIND_LOGIN=0)])],
+    HAVE_ELOGIND_LOGIN=0)
+
+AS_IF([test "x$enable_elogind_login" = "xyes" && test "x$HAVE_ELOGIND_LOGIN" = "x0"],
+    [AC_MSG_ERROR([*** Needed elogind login support not found])])
+
+AC_SUBST(HAVE_ELOGIND_LOGIN)
+AM_CONDITIONAL([HAVE_ELOGIND_LOGIN], [test "x$HAVE_ELOGIND_LOGIN" = x1])
+AS_IF([test "x$HAVE_ELOGIND_LOGIN" = "x1"], AC_DEFINE([HAVE_ELOGIND_LOGIN], 1, [Have ELOGINDLOGIN?]))
+
 #### systemd journal support (optional) ####
 
 AS_IF([test "x$enable_systemd_journal" != "xno"],
@@ -1565,6 +1583,7 @@ AS_IF([test "x$HAVE_UDEV" = "x1"], ENABLE_UDEV=yes, ENABLE_UDEV=no)
 AS_IF([test "x$HAVE_SYSTEMD_DAEMON" = "x1"], ENABLE_SYSTEMD_DAEMON=yes, ENABLE_SYSTEMD_DAEMON=no)
 AS_IF([test "x$HAVE_SYSTEMD_LOGIN" = "x1"], ENABLE_SYSTEMD_LOGIN=yes, ENABLE_SYSTEMD_LOGIN=no)
 AS_IF([test "x$HAVE_SYSTEMD_JOURNAL" = "x1"], ENABLE_SYSTEMD_JOURNAL=yes, ENABLE_SYSTEMD_JOURNAL=no)
+AS_IF([test "x$HAVE_ELOGIND_LOGIN" = "x1"], ENABLE_ELOGIND_LOGIN=yes, ENABLE_ELOGIND_LOGIN=no)
 AS_IF([test "x$HAVE_BLUEZ_4" = "x1"], ENABLE_BLUEZ_4=yes, ENABLE_BLUEZ_4=no)
 AS_IF([test "x$HAVE_BLUEZ_5" = "x1"], ENABLE_BLUEZ_5=yes, ENABLE_BLUEZ_5=no)
 AS_IF([test "x$HAVE_BLUEZ_5_OFONO_HEADSET" = "x1"], ENABLE_BLUEZ_5_OFONO_HEADSET=yes, ENABLE_BLUEZ_5_OFONO_HEADSET=no)
diff --git a/src/Makefile.am b/src/Makefile.am
index 3ff1139..16ae3f6 100644
--- a/src/Makefile.am
+++ b/src/Makefile.am
@@ -1421,6 +1421,11 @@ modlibexec_LTLIBRARIES += \
 		module-systemd-login.la
 endif
 
+if HAVE_ELOGIND_LOGIN
+modlibexec_LTLIBRARIES += \
+		module-systemd-login.la
+endif
+
 if HAVE_DBUS
 modlibexec_LTLIBRARIES += \
 		module-rygel-media-server.la \
diff --git a/src/modules/module-systemd-login.c b/src/modules/module-systemd-login.c
index d15bee5..a8b0dc5 100644
--- a/src/modules/module-systemd-login.c
+++ b/src/modules/module-systemd-login.c
@@ -28,7 +28,12 @@
 #include <stdlib.h>
 #include <sys/types.h>
 
+#ifdef HAVE_SYSTEMD_LOGIN
 #include <systemd/sd-login.h>
+#endif
+#ifdef HAVE_ELOGIND_LOGIN
+#include <elogind/sd-login.h>
+#endif
 
 #include <pulse/xmalloc.h>
 
